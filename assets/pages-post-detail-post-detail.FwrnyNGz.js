import{r as e,Y as t,s as a,a as l,c as s,w as o,i,o as n,b as r,f as d,t as u,u as c,d as p,e as _,F as m,g as v,k as f,l as y,m as b,h,j as k,p as F,n as x}from"./index-C-XsXVfx.js";import{_ as g}from"./uni-icons.CgipEwkq.js";import{o as w,b as B,c as C,r as z}from"./uni-app.es.DhiN6RXN.js";import{_ as j,a as A,U as $}from"./Utils.DUCaQH3l.js";import{s as I}from"./store.DpSSVhXf.js";import{P as T}from"./Post.Bix-bMvp.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";class V{constructor({_id:e="无效的回复_id",ordinal:t=0,replier_id:a=I.userInfo.id,replier_uname:l="username",content:s="",reply_timestamp:o,replied_post_id:i="无效的帖子_id",is_anonymous:n=!0,likes_count:r=0,is_deleted:d=!1,deleted_timestamp:u=0,deleted_reason:c="",deleter_id:p=""}={}){this._id=e,this.ordinal=t,this.replier_id=a,this.replier_uname=l,this.content=s,this.reply_timestamp=o,this.replied_post_id=i,this.is_anonymous=n,this.likes_count=r,this.is_deleted=d,this.deleted_timestamp=u,this.deleted_reason=c,this.deleter_id=p}}const D=U({__name:"post-detail",setup(U){const D=e(new T),M=e(new V),P=e({where:"0 == 1",orderby:"reply_timestamp asc"});w((e=>{P.value={where:`replied_post_id == "${e.post_id}"`,orderby:"reply_timestamp asc"},t.databaseForJQL().collection("posts").where(`_id == "${e.post_id}"`).get().then((e=>{D.value=new T(e.data[0]),Q.value.refresh()}))}));const J=e([{id:1,title:"我的回复",value:"我的回复"},{id:2,title:"最早回复",value:"最早回复"},{id:3,title:"最新回复",value:"最新回复"}]),L=e("最早回复");const Q=e(null);function q(){(function(){if(!I.userInfo._id)return h({title:"请登录后回复",icon:"none",duration:500}),!1;if(""===M.value.content.trim())return h({title:"内容不能为空",icon:"none",duration:500}),!1;return!0})()&&(f({title:"正在发送",mask:!0}),t.databaseForJQL().collection("replies").where(`replied_post_id == "${D.value._id}"`).orderBy("ordinal desc").limit(1).get().then((e=>{M.value.ordinal=e.data[0]?e.data[0].ordinal+1:1,M.value._id=void 0,M.value.replier_id=I.userInfo.id,M.value.replier_uname=M.value.is_anonymous?"匿名用户":y("tempUserInfo").uname,M.value.replied_post_id=D.value._id,b(),Q.value.add(M.value,{toastTitle:"发送成功",success:e=>{t.callFunction({name:"addPostRepliesCount",data:{_id:D.value._id}}).then((e=>{console.log(e)})),M.value=new V,Q.value.refresh()}})})))}function N(){h({title:"转发功能未开放",icon:"none",duration:500})}return B((()=>{a()})),C((()=>{Q.value.loadMore()})),(e,t)=>{const a=z(l("uni-icons"),g),f=k,y=i,b=z(l("uni-load-more"),j),w=z(l("unicloud-db"),A),B=F;return n(),s(y,{class:"container"},{default:o((()=>[r(y,{class:"post-detail-header"},{default:o((()=>[r(f,{class:"post-detail-header-button","open-type":"navigateBack"},{default:o((()=>[r(a,{type:"back",size:"46rpx",color:"#BF5AF2"})])),_:1}),r(y,{class:"post-detail-header-info"},{default:o((()=>[r(y,{class:"post-detail-id-poster"},{default:o((()=>[d(" #"+u(D.value.ordinal)+" "+u(D.value.poster_uname),1)])),_:1}),r(y,{class:"post-detail-date-time"},{default:o((()=>[d(u(c($).getFormattedTimeBefore(D.value.publish_timestamp))+" "+u(c($).getFormattedDateTime(D.value.publish_timestamp)),1)])),_:1})])),_:1}),r(y,{class:"post-detail-header-button",onClick:t[0]||(t[0]=e=>N()),"open-type":"navigateBack"},{default:o((()=>[r(a,{type:"redo",size:"56rpx",color:"#BF5AF2"})])),_:1})])),_:1}),r(y,{class:"post-detail-content"},{default:o((()=>[d(u(c($).getFormattedContent(D.value.content)),1)])),_:1}),r(y,{class:"post-detail-content-buttons-container"},{default:o((()=>[r(y,{class:"post-detail-content-button",onClick:t[1]||(t[1]=e=>{h({title:"点赞功能未开放",icon:"none",duration:500})}),"hover-class":"clicked","hover-stay-time":"200"},{default:o((()=>[r(a,{class:"post-detail-content-button-icon",type:"heart",size:"50rpx",color:"#BF5AF2"}),r(y,{class:"post-detail-content-button-label"},{default:o((()=>[d(u(D.value.likes_count),1)])),_:1})])),_:1}),r(y,{class:"post-detail-content-button",onClick:t[2]||(t[2]=e=>{h({title:"收藏功能未开放",icon:"none",duration:500})}),"hover-class":"clicked","hover-stay-time":"200"},{default:o((()=>[r(a,{class:"post-detail-content-button-icon",type:"star",size:"56rpx",color:"#BF5AF2"}),r(y,{class:"post-detail-content-button-label"},{default:o((()=>[d(u(D.value.collections_count),1)])),_:1})])),_:1}),r(y,{class:"post-detail-content-button",onClick:t[3]||(t[3]=e=>N()),"hover-class":"clicked","hover-stay-time":"200"},{default:o((()=>[r(a,{class:"post-detail-content-button-icon",type:"redo",size:"56rpx",color:"#BF5AF2"}),r(y,{class:"post-detail-content-button-label"},{default:o((()=>[d(u(D.value.forwards_count),1)])),_:1})])),_:1})])),_:1}),r(y,{class:"reply-count"},{default:o((()=>[d(u(D.value.replies_count)+" 回复 ",1)])),_:1}),r(y,{class:"reply-nav-bar"},{default:o((()=>[(n(!0),p(m,null,_(J.value,((e,t)=>(n(),s(y,{class:x(["reply-nav-bar-item",{active:e.value===L.value}]),onClick:e=>function(e){if(L.value!==J.value[e].value)switch(L.value=J.value[e].value,L.value){case"我的回复":P.value={where:`replied_post_id == "${D.value._id}" && replier_id == "${I.userInfo._id}"`,orderby:"reply_timestamp asc"};break;case"最早回复":P.value={where:`replied_post_id == "${D.value._id}"`,orderby:"reply_timestamp asc"};break;case"最新回复":P.value={where:`replied_post_id == "${D.value._id}"`,orderby:"reply_timestamp desc"};break;default:console.log("无效的replyNavBarValue.value: ",L.value)}}(t),key:t},{default:o((()=>[d(u(e.title),1)])),_:2},1032,["onClick","class"])))),128))])),_:1}),r(w,{collection:"replies",fields:"_id, content, replier_uname, replier_id, reply_timestamp, likes_count, is_deleted",where:P.value.where,orderby:P.value.orderby,"page-data":"add","page-size":10,loadtime:"auto",ref_key:"repliesUDB",ref:Q},{default:o((({data:e,loading:t,hasMore:a,error:l,options:i})=>[l?(n(),s(y,{key:0},{default:o((()=>[d(u(l.message),1)])),_:2},1024)):v("",!0),r(y,{class:"replies-container"},{default:o((()=>[(n(!0),p(m,null,_(e,((e,t)=>(n(),s(y,{class:"reply-card",key:e._id},{default:o((()=>[r(y,{class:"reply-card-id-replier"},{default:o((()=>[d(" #"+u(e.ordinal)+" "+u(e.replier_uname),1)])),_:2},1024),r(y,{class:"reply-card-content"},{default:o((()=>[d(u(c($).getFormattedContent(e.content)),1)])),_:2},1024),r(y,{class:"reply-card-date-time"},{default:o((()=>[d(u(c($).getFormattedTimeBefore(e.reply_timestamp))+" "+u(c($).getFormattedDateTime(e.reply_timestamp)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024),t?(n(),s(y,{key:1},{default:o((()=>[r(b,{status:"loading"})])),_:1})):a?v("",!0):(n(),s(b,{key:2,status:"noMore"}))])),_:1},8,["where","orderby"]),r(y,{class:"reply-box"},{default:o((()=>[r(B,{class:"reply-box-input",modelValue:M.value.content,"onUpdate:modelValue":t[4]||(t[4]=e=>M.value.content=e),placeholder:"说点什么吧 ~",maxlength:"500"},null,8,["modelValue"]),r(y,{class:"reply-box-buttons-container"},{default:o((()=>[r(y,{class:"reply-box-button",onClick:t[5]||(t[5]=e=>{h({title:"上传功能未开放",icon:"none",duration:500})})},{default:o((()=>[r(y,{class:"reply-box-button-label"},{default:o((()=>[d("上传")])),_:1}),r(y,{class:"reply-box-button-icon"},{default:o((()=>[r(a,{type:"image",size:"46rpx",color:"#BF5AF2"})])),_:1})])),_:1}),r(y,{class:"reply-box-button",onClick:t[6]||(t[6]=e=>M.value.is_anonymous=!M.value.is_anonymous)},{default:o((()=>[r(y,{class:"reply-box-button-label"},{default:o((()=>[d(u(M.value.is_anonymous?"已匿名":"未匿名"),1)])),_:1}),r(y,{class:"reply-box-button-icon"},{default:o((()=>[r(a,{type:M.value.is_anonymous?"help":"auth",size:"46rpx",color:"#BF5AF2"},null,8,["type"])])),_:1})])),_:1}),r(y,{class:"reply-box-button",onClick:t[7]||(t[7]=e=>q())},{default:o((()=>[r(y,{class:"reply-box-button-label"},{default:o((()=>[d("回复")])),_:1}),r(y,{class:"reply-box-button-icon"},{default:o((()=>[r(a,{type:"paperplane",size:"46rpx",color:"#BF5AF2"})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-664a600b"]]);export{D as default};
