import{r as e,Y as a,s as t,a as l,c as s,w as o,i,o as r,b as d,f as n,t as u,u as p,d as _,e as c,F as m,g as v,k as y,l as f,m as b,h,j as k,p as g,n as x}from"./index-CHMtd8Q1.js";import{_ as F}from"./uni-icons.CWyZj6tD.js";import{o as w,b as B,c as j,r as C}from"./uni-app.es.BJJPZxZ3.js";import{_ as $,a as z,U as I}from"./Utils.DOYmfBem.js";import{s as A}from"./store.BSHOeR6v.js";import{P as T}from"./Post.o_hdM71O.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";class V{constructor({_id:e="无效的回复_id",ordinal:a=0,replier_id:t=A.userInfo.id,replier_uname:l="username",content:s="",reply_timestamp:o,replied_post_id:i="无效的帖子_id",is_anonymous:r=!0,likes_count:d=0,is_deleted:n=!1,deleted_timestamp:u=0,deleted_reason:p="",deleter_id:_=""}={}){this._id=e,this.ordinal=a,this.replier_id=t,this.replier_uname=l,this.content=s,this.reply_timestamp=o,this.replied_post_id=i,this.is_anonymous=r,this.likes_count=d,this.is_deleted=n,this.deleted_timestamp=u,this.deleted_reason=p,this.deleter_id=_}}const D=U({__name:"post-detail",setup(U){const D=e(new T),M=e(new V),P=e({where:"0 == 1",orderby:"reply_timestamp asc"});w((e=>{P.value={where:`replied_post_id == "${e.post_id}"`,orderby:"reply_timestamp asc"},a.databaseForJQL().collection("posts").where(`_id == "${e.post_id}"`).get().then((e=>{D.value=new T(e.data[0]),Q.value.refresh()}))}));const J=e([{id:1,title:"我的回复",value:"我的回复"},{id:2,title:"最早回复",value:"最早回复"},{id:3,title:"最新回复",value:"最新回复"}]),L=e("最早回复");const Q=e(null);function q(){(function(){if(!A.userInfo._id)return h({title:"请登录后回复",icon:"none",duration:500}),!1;if(""===M.value.content.trim())return h({title:"内容不能为空",icon:"none",duration:500}),!1;return!0})()&&(y({title:"正在发送",mask:!0}),a.databaseForJQL().collection("replies").where(`replied_post_id == "${D.value._id}"`).orderBy("ordinal desc").limit(1).get().then((e=>{M.value.ordinal=e.data[0]?e.data[0].ordinal+1:1,M.value._id=void 0,M.value.replier_id=A.userInfo.id,M.value.replier_uname=M.value.is_anonymous?"匿名用户":f("tempUserInfo").uname,M.value.replied_post_id=D.value._id,b(),Q.value.add(M.value,{toastTitle:"发送成功",success:e=>{a.callFunction({name:"replyPost",data:{_id:D.value._id}}).then((e=>{console.log(e)})),M.value=new V,Q.value.refresh()}})})))}return B((()=>{t()})),j((()=>{Q.value.loadMore()})),(e,a)=>{const t=C(l("uni-icons"),F),y=k,f=i,b=C(l("uni-load-more"),$),w=C(l("unicloud-db"),z),B=g;return r(),s(f,{class:"container"},{default:o((()=>[d(f,{class:"post-detail-header"},{default:o((()=>[d(y,{class:"post-detail-header-button","open-type":"navigateBack"},{default:o((()=>[d(t,{type:"back",size:"46rpx",color:"#BF5AF2"})])),_:1}),d(f,{class:"post-detail-header-info"},{default:o((()=>[d(f,{class:"post-detail-id-poster"},{default:o((()=>[n(" #"+u(D.value.ordinal)+" "+u(D.value.poster_uname),1)])),_:1}),d(f,{class:"post-detail-date-time"},{default:o((()=>[n(u(p(I).getFormattedTimeBefore(D.value.publish_timestamp))+" "+u(p(I).getFormattedDateTime(D.value.publish_timestamp)),1)])),_:1})])),_:1}),d(f,{class:"post-detail-header-button",onClick:a[0]||(a[0]=e=>{h({title:"转发功能未开放",icon:"none",duration:500})}),"open-type":"navigateBack"},{default:o((()=>[d(t,{type:"redo",size:"56rpx",color:"#BF5AF2"})])),_:1})])),_:1}),d(f,{class:"post-detail-content"},{default:o((()=>[n(u(p(I).getFormattedContent(D.value.content)),1)])),_:1}),d(f,{class:"post-detail-content-buttons-container"}),d(f,{class:"reply-count"},{default:o((()=>[n(u(D.value.replies_count)+" 回复 ",1)])),_:1}),d(f,{class:"reply-nav-bar"},{default:o((()=>[(r(!0),_(m,null,c(J.value,((e,a)=>(r(),s(f,{class:x(["reply-nav-bar-item",{active:e.value===L.value}]),onClick:e=>function(e){if(L.value!==J.value[e].value)switch(L.value=J.value[e].value,L.value){case"我的回复":P.value={where:`replied_post_id == "${D.value._id}" && replier_id == "${A.userInfo._id}"`,orderby:"reply_timestamp asc"};break;case"最早回复":P.value={where:`replied_post_id == "${D.value._id}"`,orderby:"reply_timestamp asc"};break;case"最新回复":P.value={where:`replied_post_id == "${D.value._id}"`,orderby:"reply_timestamp desc"};break;default:console.log("无效的replyNavBarValue.value: ",L.value)}}(a),key:a},{default:o((()=>[n(u(e.title),1)])),_:2},1032,["onClick","class"])))),128))])),_:1}),d(w,{collection:"replies",fields:"_id, content, replier_uname, replier_id, reply_timestamp, likes_count, is_deleted",where:P.value.where,orderby:P.value.orderby,"page-data":"add","page-size":10,loadtime:"auto",ref_key:"repliesUDB",ref:Q},{default:o((({data:e,loading:a,hasMore:t,error:l,options:i})=>[l?(r(),s(f,{key:0},{default:o((()=>[n(u(l.message),1)])),_:2},1024)):v("",!0),d(f,{class:"replies-container"},{default:o((()=>[(r(!0),_(m,null,c(e,((e,a)=>(r(),s(f,{class:"reply-card",key:e._id},{default:o((()=>[d(f,{class:"reply-card-id-replier"},{default:o((()=>[n(" #"+u(e.ordinal)+" "+u(e.replier_uname),1)])),_:2},1024),d(f,{class:"reply-card-content"},{default:o((()=>[n(u(p(I).getFormattedContent(e.content)),1)])),_:2},1024),d(f,{class:"reply-card-date-time"},{default:o((()=>[n(u(p(I).getFormattedTimeBefore(e.reply_timestamp))+" "+u(p(I).getFormattedDateTime(e.reply_timestamp)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024),a?(r(),s(f,{key:1},{default:o((()=>[d(b,{status:"loading"})])),_:1})):t?v("",!0):(r(),s(b,{key:2,status:"noMore"}))])),_:1},8,["where","orderby"]),d(f,{class:"reply-box"},{default:o((()=>[d(B,{class:"reply-box-input",modelValue:M.value.content,"onUpdate:modelValue":a[1]||(a[1]=e=>M.value.content=e),placeholder:"说点什么吧 ~",maxlength:"500"},null,8,["modelValue"]),d(f,{class:"reply-box-buttons-container"},{default:o((()=>[d(f,{class:"reply-box-button",onClick:a[2]||(a[2]=e=>{h({title:"上传功能未开放",icon:"none",duration:500})})},{default:o((()=>[d(f,{class:"reply-box-button-label"},{default:o((()=>[n("上传")])),_:1}),d(f,{class:"reply-box-button-icon"},{default:o((()=>[d(t,{type:"image",size:"46rpx",color:"#BF5AF2"})])),_:1})])),_:1}),d(f,{class:"reply-box-button",onClick:a[3]||(a[3]=e=>M.value.is_anonymous=!M.value.is_anonymous)},{default:o((()=>[d(f,{class:"reply-box-button-label"},{default:o((()=>[n(u(M.value.is_anonymous?"已匿名":"未匿名"),1)])),_:1}),d(f,{class:"reply-box-button-icon"},{default:o((()=>[d(t,{type:M.value.is_anonymous?"help":"auth",size:"46rpx",color:"#BF5AF2"},null,8,["type"])])),_:1})])),_:1}),d(f,{class:"reply-box-button",onClick:a[4]||(a[4]=e=>q())},{default:o((()=>[d(f,{class:"reply-box-button-label"},{default:o((()=>[n("回复")])),_:1}),d(f,{class:"reply-box-button-icon"},{default:o((()=>[d(t,{type:"paperplane",size:"46rpx",color:"#BF5AF2"})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-5a06f6d8"]]);export{D as default};
